{% assign current_variant = product.selected_or_first_available_variant %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": {{ product.title | json }},
  "url": {{ shop.url | append: product.url | json }},
  {%- if product.media.size > 0 -%}
    "image": [
      {%- for media in product.media -%}
        {%- if media.media_type == 'image' -%}
          {%- assign media_size = media.preview_image.width | append: 'x' -%}
          {{ media | img_url: media_size | prepend: "https:" | json }}{% unless forloop.last %},{% endunless %}
        {%- endif -%}
      {%- endfor -%}
    ],
  {%- endif -%}
  "description": {{ product.description | strip_html | truncate: 5000 | json }},
  {%- if current_variant.sku != blank -%}
    "sku": {{ current_variant.sku | json }},
  {%- endif -%}
  {%- if product.metafields.reviews.rating.value != blank -%}
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": {{ product.metafields.reviews.rating.value | json }},
      "reviewCount": {{ product.metafields.reviews.rating_count.value | default: 1 | json }}
    },
  {%- endif -%}
  "brand": {
    "@type": "Brand",
    "name": {{ product.vendor | json }}
  },
  "offers": [
    {%- for variant in product.variants -%}
      {
        "@type" : "Offer",
        {%- if variant.sku != blank -%}
          "sku": {{ variant.sku | json }},
        {%- endif -%}
        {%- if variant.barcode != blank -%}
          "gtin": {{ variant.barcode | json }},
        {%- endif -%}
        "name": {{ variant.title | json }},
        "availability" : "https://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
        "itemCondition": "https://schema.org/NewCondition",
        "price" : {{ variant.price | money_without_currency | strip_html | json }},
        "priceCurrency" : {{ cart.currency.iso_code | json }},
        "priceValidUntil": "{{ 'now' | date: '%Y' | plus: 1 }}-12-31",
        "url" : {{ shop.url | append: variant.url | json }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]
}
</script>
